(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&a(o)}).observe(document,{childList:!0,subtree:!0});function n(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(r){if(r.ep)return;r.ep=!0;const s=n(r);fetch(r.href,s)}})();let L,l;const u={baseUrl:"https://tms.tabadul.sa/api/appointment/tas/v2/",fleetBaseUrl:"https://tms.tabadul.sa/api/fleet/v2/",mockBaseUrl:"https://67fbc19b1f8b41c81684c4e8.mockapi.io/api/fasah/v1/"},p=()=>new Date(Date.now()+864e5).toLocaleDateString("en-CA").replace(/-/g,"/"),h=async(t,e={},n=u.baseUrl)=>{const a={"Accept-Language":"ar",Accept:"application/json",token:decodeURIComponent(L)};return await(await fetch(`${n+t}`,{method:"GET",...e,headers:{...a,...e==null?void 0:e.headers}})).json()};document.addEventListener("DOMContentLoaded",()=>{l=JSON.parse(localStorage.getItem("truckData")||"[]"),S();const t=document.getElementById("start-btn"),e=document.getElementById("stop-btn");t==null||t.addEventListener("click",w),e==null||e.addEventListener("click",k)});function S(){if(l&&l.length){const t=document.getElementById("trucks-list");if(!t)return;t.innerHTML="",l.forEach((e,n)=>{const a=document.createElement("li");a.className="flex gap-4 truck-item",a.innerHTML=`
         <input
            type="text"
            id="truck-name"
            class="min-w-0 input input-bordered flex-1 h-[2.5rem] rounded-md"
            placeholder="اسم السائق"
            ${n===0?"autofocus":""}
            value="${e.name}"
          />
          <input
            type="text"
            id="truck-number"
            class="min-w-0 input input-bordered flex-1 h-[2.5rem] rounded-md"
            placeholder="رقم السيارة"
            value="${e.truckNumber}"
          />
          <input
            type="text"
            id="truck-declaration-number"
            class="min-w-0 input input-bordered flex-1 h-[2.5rem] rounded-md"
            placeholder="رقم البيان الجمركى"
            value="${e.customsDeclarationNumber}"
          />
      `,t.appendChild(a)})}}async function w(){const t=document.getElementById("stop-btn");try{v(!1),t==null||t.classList.remove("hidden"),g(!0),f("جاري معالجة البيانات..."),y("disable"),await N(),x()&&await T()}catch(e){const n=document.getElementById("info-alert");n==null||n.classList.remove("flex"),n==null||n.classList.add("hidden"),g(!1);const a=document.getElementById("error-alert");a==null||a.classList.remove("hidden"),a==null||a.classList.add("flex");const r=a==null?void 0:a.querySelector("#error-alert-msg");r&&(r.textContent=e),y("enable"),t==null||t.classList.add("hidden")}}async function k(){window.location.reload()}function g(t){const e=document.getElementById("filling-loading");t?(e==null||e.classList.remove("hidden"),e==null||e.classList.add("flex")):(e==null||e.classList.remove("flex"),e==null||e.classList.add("hidden"))}function f(t){document.getElementById("message").innerText=t}function y(t){const e=document.getElementById("form"),n=e==null?void 0:e.querySelectorAll("input");n==null||n.forEach(a=>{t==="enable"?a.disabled=!1:t==="disable"&&(a.disabled=!0)}),E(t)}function E(t){const e=document.getElementById("start-btn");t==="enable"?e.disabled=!1:t==="disable"&&(e.disabled=!0)}async function N(){await new Promise((t,e)=>{chrome.tabs.query({active:!0,currentWindow:!0},n=>{const a=n[0];chrome.tabs.sendMessage(a.id,{action:"getToken"},r=>{(r==null?void 0:r.status)==="success"?r.message==="getToken"&&(L=r.data.token,t(!0)):e("لا يوجد توكن الرجاء تسجيل الدخول من تانى")})})})}function x(){const t=[];let e=!1;if(document.querySelectorAll(".truck-item").forEach(n=>{const a=n.querySelector("#truck-name"),r=n.querySelector("#truck-number"),s=n.querySelector("#truck-declaration-number"),o=a.value.trim(),c=r.value.trim(),d=s.value.trim();a.classList.remove("input-error"),r.classList.remove("input-error"),s.classList.remove("input-error"),o||(a.classList.add("input-error"),e=!0),c||(r.classList.add("input-error"),e=!0),d||(s.classList.add("input-error"),e=!0),o&&c&&d&&t.push({name:o,truckNumber:c,customsDeclarationNumber:d})}),e)alert("يرجى ملء جميع الحقول المطلوبة!");else{if(t.length>0)return localStorage.setItem("truckData",JSON.stringify(t)),l=t,!0;alert("يرجى إضافة شاحنة واحدة على الأقل ببيانات صحيحة.")}return!1}const b=async()=>{var a,r;f("جارى البحث عن مواعيد...");const t={economicOperator:"",type:"TRANSIT",departure:"KFC",arrival:"31"},e=new URLSearchParams(t),n=await h(`zone/schedule/land?${e.toString()}`);if(Reflect.has(n,"schedules")){const s=n.schedules,o=s.length>3?s[s.length-3]:s[0];return await fetch(`${u.mockBaseUrl}/schedule`,{method:"POST",body:JSON.stringify({response:o,payload:t}),headers:{"Content-Type":"application/json"}}),o}if((n==null?void 0:n.success)===!1){if((r=(a=n==null?void 0:n.errors)==null?void 0:a[0])!=null&&r.message.includes("تم تجاوز الحد الأقصى")){let s=!1;f(" تم تجاوز الحد الأقصى هنستنى 15 ثواني وبعدين نعيد المحاولة لو مش هتستنى انت تقدر ");const o=document.createElement("button");o.innerText="تضغط هنا",o.classList.add("text-primary","cursor-pointer"),o.addEventListener("click",()=>{s=!0,w()});const c=document.getElementById("message");return c==null||c.appendChild(o),await new Promise(m=>setTimeout(()=>{m(!s)},15e3))?b():void 0}return b()}},B=async t=>{var d,m;f("جاري البحث عن معلومات السائق... والشاحنة");const e=new URLSearchParams({finalDestination:"95",finalDestinationTime:p(),q:t.truckNumber}),n=await h(`truck/verified/all/forAdd?${e.toString()}`,void 0,u.fleetBaseUrl),a=new URLSearchParams({finalDestination:"95",finalDestinationTime:p(),q:t.name}),r=await h(`driver/verified/all/forAdd?${a.toString()}`,void 0,u.fleetBaseUrl);if(!((d=n==null?void 0:n.content)!=null&&d[0]))throw new Error("يوجد خطأ فى معلومات الشاحنة");if(!((m=r==null?void 0:r.content)!=null&&m[0]))throw new Error("يوجد خطأ فى معلومات السائق");const s=n.content.filter(i=>i.plateNumberAr.trim()===t.truckNumber.trim()),o=r.content.filter(i=>i.nameAr.trim().startsWith(t.name.trim())),c=document.getElementById("info-alert");if((s.length>1||o.length>1)&&c){c.classList.remove("hidden"),c.classList.add("flex");const i=c.querySelector("#info-alert-msg");s.length>1&&i&&(i.textContent="يوجد اكتر من شاحنه بنفس رقم السيارة علشان الوقت انا اختارتلك اول سيارة ليها نفس الرقم"),o.length>1&&i&&(i.textContent+="يوجد اكتر من سائق بنفس الاسم علشان الوقت انا اختارتلك اول سائق ليها نفس الاسم")}if(!(s!=null&&s[0]))throw new Error(`لم يتم العثور على شاحنة برقم السيارة ${t.truckNumber}`);if(!(o!=null&&o[0]))throw new Error(`لم يتم العثور على سائق بالاسم ${t.name}`);return await fetch(`${u.mockBaseUrl}/get-info`,{method:"POST",body:JSON.stringify({response:{truck:s==null?void 0:s[0],driver:o==null?void 0:o[0],data:t,truckResponse:n,driverResponse:r},payload:{finalDestination:"95",finalDestinationTime:p(),q:t.truckNumber}}),headers:{"Content-Type":"application/json"}}),{truck:s==null?void 0:s[0],driver:o==null?void 0:o[0],data:t}},C=async t=>{var a,r;f("جاري حجز الموعد...");const e={declaration_number:t.data.customsDeclarationNumber,port_code:t.schedule.port_code,zone_schedule_id:t.schedule.zone_schedule_id,bayan_appointment:{},cargo_type:"",purpose:"6",fleet_info:[{chassisNo:t.truck.chassisNo,licenseNo:t.driver.licenseNo,plateCountry:t.truck.plateCountry,residentCountry:t.driver.residentCountry,vehicleSequenceNumber:t.truck.vehicleSequenceNumber}]},n=await h("appointment/transit/create",{method:"POST",body:JSON.stringify(e),headers:{"Content-Type":"application/json"}});if(await fetch(`${u.mockBaseUrl}/create-schedual`,{method:"POST",body:JSON.stringify({response:n,payload:{...e,appointmentData:t.data}}),headers:{"Content-Type":"application/json"}}),!n.success)throw Array.isArray(n.errors)?new Error((r=(a=n.errors)==null?void 0:a[0])==null?void 0:r.message):new Error("حدث خطاء فى حجز الموعد");return n};async function T(){var e;const t=await b();if(t){const n=await B(l==null?void 0:l[0]);n!=null&&n.driver&&n.truck&&n.data&&await C({...n,schedule:t})&&(v(!0),y("enable"),g(!1),(e=document.getElementById("stop-btn"))==null||e.classList.add("hidden"))}}function v(t){const e=document.getElementById("success-alert");t?(e==null||e.classList.add("flex"),e==null||e.classList.remove("hidden")):(e==null||e.classList.add("hidden"),e==null||e.classList.remove("flex"))}
