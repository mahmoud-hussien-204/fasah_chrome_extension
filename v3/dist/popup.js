(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&r(c)}).observe(document,{childList:!0,subtree:!0});function s(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(n){if(n.ep)return;n.ep=!0;const a=s(n);fetch(n.href,a)}})();let L,d;const f={baseUrl:"https://tms.tabadul.sa/api/appointment/tas/v2/",fleetBaseUrl:"https://tms.tabadul.sa/api/fleet/v2/"},b=()=>new Date(Date.now()+864e5).toLocaleDateString("en-CA").replace(/-/g,"/"),m=async(t,e={},s=f.baseUrl)=>{const r={"Accept-Language":"ar",Accept:"application/json",token:decodeURIComponent(L)};return await(await fetch(`${s+t}`,{method:"GET",...e,headers:{...r,...e==null?void 0:e.headers}})).json()};document.addEventListener("DOMContentLoaded",()=>{d=JSON.parse(localStorage.getItem("truckData")||"[]"),E();const t=document.getElementById("start-btn"),e=document.getElementById("stop-btn");t==null||t.addEventListener("click",v),e==null||e.addEventListener("click",S)});function E(){if(d&&d.length){const t=document.getElementById("trucks-list");if(!t)return;t.innerHTML="",d.forEach((e,s)=>{const r=document.createElement("li");r.className="flex gap-4 truck-item",r.innerHTML=`
         <input
            type="text"
            id="truck-name"
            class="min-w-0 input input-bordered flex-1 h-[2.5rem] rounded-md"
            placeholder="اسم السائق"
            ${s===0?"autofocus":""}
            value="${e.name}"
          />
          <input
            type="text"
            id="truck-number"
            class="min-w-0 input input-bordered flex-1 h-[2.5rem] rounded-md"
            placeholder="رقم السيارة"
            value="${e.truckNumber}"
          />
          <input
            type="text"
            id="truck-declaration-number"
            class="min-w-0 input input-bordered flex-1 h-[2.5rem] rounded-md"
            placeholder="رقم البيان الجمركى"
            value="${e.customsDeclarationNumber}"
          />
      `,t.appendChild(r)})}}async function v(){const t=document.getElementById("stop-btn");try{w(!1),t==null||t.classList.remove("hidden"),h(!0),u("جاري معالجة البيانات..."),g("disable"),await N(),x()&&await A()}catch(e){const s=document.getElementById("info-alert");s==null||s.classList.remove("flex"),s==null||s.classList.add("hidden"),h(!1);const r=document.getElementById("error-alert");r==null||r.classList.remove("hidden"),r==null||r.classList.add("flex");const n=r==null?void 0:r.querySelector("#error-alert-msg");n&&(n.textContent=e),g("enable"),t==null||t.classList.add("hidden")}}async function S(){window.location.reload()}function h(t){const e=document.getElementById("filling-loading");t?(e==null||e.classList.remove("hidden"),e==null||e.classList.add("flex")):(e==null||e.classList.remove("flex"),e==null||e.classList.add("hidden"))}function u(t){document.getElementById("message").innerText=t}function g(t){const e=document.getElementById("form"),s=e==null?void 0:e.querySelectorAll("input");s==null||s.forEach(r=>{t==="enable"?r.disabled=!1:t==="disable"&&(r.disabled=!0)}),k(t)}function k(t){const e=document.getElementById("start-btn");t==="enable"?e.disabled=!1:t==="disable"&&(e.disabled=!0)}async function N(){await new Promise((t,e)=>{chrome.tabs.query({active:!0,currentWindow:!0},s=>{const r=s[0];chrome.tabs.sendMessage(r.id,{action:"getToken"},n=>{(n==null?void 0:n.status)==="success"?n.message==="getToken"&&(L=n.data.token,t(!0)):e("لا يوجد توكن الرجاء تسجيل الدخول من تانى")})})})}function x(){const t=[];let e=!1;if(document.querySelectorAll(".truck-item").forEach(s=>{const r=s.querySelector("#truck-name"),n=s.querySelector("#truck-number"),a=s.querySelector("#truck-declaration-number"),c=r.value.trim(),o=n.value.trim(),i=a.value.trim();r.classList.remove("input-error"),n.classList.remove("input-error"),a.classList.remove("input-error"),c||(r.classList.add("input-error"),e=!0),o||(n.classList.add("input-error"),e=!0),i||(a.classList.add("input-error"),e=!0),c&&o&&i&&t.push({name:c,truckNumber:o,customsDeclarationNumber:i})}),e)alert("يرجى ملء جميع الحقول المطلوبة!");else{if(t.length>0)return localStorage.setItem("truckData",JSON.stringify(t)),d=t,!0;alert("يرجى إضافة شاحنة واحدة على الأقل ببيانات صحيحة.")}return!1}const p=async()=>{var s,r;u("جارى البحث عن مواعيد...");const t=new URLSearchParams({economicOperator:"",type:"TRANSIT",departure:"KFC",arrival:"31"}),e=await m(`zone/schedule/land?${t.toString()}`);if(Reflect.has(e,"schedules")){const n=e.schedules;return n.length>3?n[n.length-3]:n[0]}if((e==null?void 0:e.success)===!1){if((r=(s=e==null?void 0:e.errors)==null?void 0:s[0])!=null&&r.message.includes("تم تجاوز الحد الأقصى")){let n=!1;u(" تم تجاوز الحد الأقصى هنستنى 15 ثواني وبعدين نعيد المحاولة لو مش هتستنى انت تقدر ");const a=document.createElement("button");a.innerText="تضغط هنا",a.classList.add("text-primary","cursor-pointer"),a.addEventListener("click",()=>{n=!0,v()});const c=document.getElementById("message");return c==null||c.appendChild(a),await new Promise(i=>setTimeout(()=>{i(!n)},15e3))?p():void 0}return p()}},I=async t=>{var i,y;u("جاري البحث عن معلومات السائق... والشاحنة");const e=new URLSearchParams({finalDestination:"95",finalDestinationTime:b(),q:t.truckNumber}),s=await m(`truck/verified/all/forAdd?${e.toString()}`,void 0,f.fleetBaseUrl),r=new URLSearchParams({finalDestination:"95",finalDestinationTime:b(),q:t.name}),n=await m(`driver/verified/all/forAdd?${r.toString()}`,void 0,f.fleetBaseUrl);if(!((i=s==null?void 0:s.content)!=null&&i[0])||!((y=n==null?void 0:n.content)!=null&&y[0]))throw new Error("يوجد خطأ فى معلومات السائق والشاحنة");const a=s.content.filter(l=>l.plateNumberAr.trim()===t.truckNumber),c=n.content.filter(l=>l.nameAr.trim()===t.name),o=document.getElementById("info-alert");if((a.length>1||c.length>1)&&o){o.classList.remove("hidden"),o.classList.add("flex");const l=o.querySelector("#info-alert-msg");a.length>1&&l&&(l.textContent="يوجد اكتر من شاحنه بنفس رقم السيارة علشان الوقت انا اختارتلك اول سيارة ليها نفس الرقم"),c.length>1&&l&&(l.textContent+="يوجد اكتر من سائق بنفس الاسم علشان الوقت انا اختارتلك اول سائق ليها نفس الاسم")}return{truck:a==null?void 0:a[0],driver:c==null?void 0:c[0],data:t}},D=async t=>{var r,n;u("جاري حجز الموعد...");const e={purpose:"6",fleet_info:[{licenseNo:t.driver.licenseNo,residentCountry:t.driver.residentCountry,plateCountry:t.truck.plateCountry,vehicleSequenceNumber:t.truck.vehicleSequenceNumber,chassisNo:t.truck.chassisNo}],transit:{transit_port_code:t.schedule.port_code,transit_schedule_id:t.schedule.zone_schedule_id},declaration_number:t.data.customsDeclarationNumber},s=await m("appointment/transit/create",{method:"POST",body:JSON.stringify(e),headers:{"Content-Type":"application/json"}});if(!s.success)throw Array.isArray(s.errors)?new Error((n=(r=s.errors)==null?void 0:r[0])==null?void 0:n.message):new Error("حدث خطاء فى حجز الموعد");return s};async function A(){var e;const t=await p();if(t){const s=await I(d==null?void 0:d[0]);s!=null&&s.driver&&s.truck&&s.data&&await D({...s,schedule:t})&&(w(!0),g("enable"),h(!1),(e=document.getElementById("stop-btn"))==null||e.classList.add("hidden"))}}function w(t){const e=document.getElementById("success-alert");t?(e==null||e.classList.add("flex"),e==null||e.classList.remove("hidden")):(e==null||e.classList.add("hidden"),e==null||e.classList.remove("flex"))}
